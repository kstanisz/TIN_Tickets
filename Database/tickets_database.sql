CREATE DATABASE tickets;
USE tickets;

DROP TABLE Ticket;
DROP TABLE User_Has_Service;
DROP TABLE User;
DROP TABLE Service;

CREATE TABLE User(
	ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IP VARCHAR(30) UNIQUE NOT NULL,
    SALT VARCHAR(256),
    PASSWORD_HASH VARCHAR(5000)
);

CREATE TABLE Service(
	ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    NAME VARCHAR(100) UNIQUE NOT NULL
);

CREATE TABLE User_Has_Service(
	ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    USER_ID INT UNSIGNED NOT NULL,
    SERVICE_ID INT UNSIGNED NOT NULL,
    
    FOREIGN KEY(USER_ID) REFERENCES User(ID),
    FOREIGN KEY(SERVICE_ID) REFERENCES Service(ID)

);

CREATE TABLE Ticket(
	ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    USER_ID INT UNSIGNED NOT NULL,
    SERVICE_ID INT UNSIGNED NOT NULL,
    CHECKSUM VARCHAR(3000), 
    EXPIRY_DATE TIMESTAMP DEFAULT NOW(),
    
	FOREIGN KEY(USER_ID) REFERENCES User(ID),
    FOREIGN KEY(SERVICE_ID) REFERENCES Service(ID)
);

INSERT INTO User(ID,IP) VALUES(1,'127.0.0.1');
INSERT INTO User(ID,IP) VALUES(2,'127.0.0.2');
INSERT INTO User(ID,IP) VALUES(3,'127.0.0.3');

INSERT INTO Service(ID,NAME) VALUES(1,'UDP_ECHO');
INSERT INTO Service(ID,NAME) VALUES(2,'UDP_TIME');
INSERT INTO Service(ID,NAME) VALUES(3,'TCP_ECHO');

INSERT INTO User_Has_Service(ID,USER_ID,SERVICE_ID) VALUES(1,1,1);
INSERT INTO User_Has_Service(ID,USER_ID,SERVICE_ID) VALUES(2,1,2);
INSERT INTO User_Has_Service(ID,USER_ID,SERVICE_ID) VALUES(3,1,3);

INSERT INTO User_Has_Service(ID,USER_ID,SERVICE_ID) VALUES(4,2,1);
INSERT INTO User_Has_Service(ID,USER_ID,SERVICE_ID) VALUES(5,2,2);

INSERT INTO User_Has_Service(ID,USER_ID,SERVICE_ID) VALUES(6,3,1);

commit;
